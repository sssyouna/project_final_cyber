events {
    worker_connections 1024;
}

http {
    # M11: Verbose error logging - maximum verbosity to expose internal paths
    error_log /var/log/nginx/error.log debug;
    
    # M11: Instead of error pages, let backend handle errors with detailed information
    # This allows backend error details to be exposed through the proxy

    server {
        listen 80;
        server_name localhost;

        # M3: Directory listing enabled
        # More specific endpoints first
        location /uploads/permissions {
            proxy_pass http://backend:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Forward uploads directory requests to backend for PHP execution
        location /uploads/ {
            proxy_pass http://backend:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Remove specific rule that blocks sensitive file access from backend
        # Sensitive file access is now handled by the backend application

        # M8: No security headers
        # Missing: HSTS, CSP, X-Content-Type-Options, X-Frame-Options

        location / {
            proxy_pass http://backend:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # M11: Forward all error details from backend without sanitization
            proxy_intercept_errors off;  # Don't intercept errors, pass through to client
            
            # M11: Enable detailed proxy error logging
            proxy_redirect off;
            proxy_buffering off;  # Don't buffer responses to ensure immediate error feedback
            
            # M11: Add debug headers that might expose internal information
            add_header X-Debug-Info "Backend: backend:8000" always;
        }
    }
}